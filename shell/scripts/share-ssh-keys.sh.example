#!/bin/bash
# SSH Key Setup and Distribution Script

KEY_NAME="${1:-id_ed25519}"
KEY_PATH="$HOME/.ssh/$KEY_NAME"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# List of hosts to distribute keys to
# Format: "user@host" or just "host" (will use current user)
# Add both eigyn and root entries for hosts where you need both users
HOSTS=(
    # Pihole 1 - Primary DNS
    "eigyn@10.0.10.3"
    "root@10.0.10.3"
    
    # Pihole 2 - Secondary DNS
    "eigyn@10.0.10.4"
    "root@10.0.10.4"
    
    # Hypervisor - Proxmox
    "eigyn@10.0.10.5"
    "root@10.0.10.5"
    
    # Compute - Ubuntu VM
    "eigyn@10.0.10.8"
    "root@10.0.10.8"
    
    # Add more hosts here
    "jaredconnor@10.0.40.5"
)

echo -e "${GREEN}=== SSH Key Setup and Distribution ===${NC}\n"

# Check if .ssh directory exists
if [ ! -d "$HOME/.ssh" ]; then
    echo -e "${YELLOW}Creating ~/.ssh directory...${NC}"
    mkdir -p "$HOME/.ssh"
    chmod 700 "$HOME/.ssh"
fi

# Check if key already exists
if [ -f "$KEY_PATH" ]; then
    echo -e "${GREEN}✓ SSH key already exists at $KEY_PATH${NC}"
    read -p "Do you want to use this existing key? (y/n): " use_existing
    if [ "$use_existing" != "y" ]; then
        read -p "Generate a new key with a different name? Enter name (or 'q' to quit): " new_name
        if [ "$new_name" == "q" ]; then
            echo "Exiting."
            exit 0
        fi
        KEY_NAME="$new_name"
        KEY_PATH="$HOME/.ssh/$KEY_NAME"
    fi
fi

# Generate key if it doesn't exist
if [ ! -f "$KEY_PATH" ]; then
    echo -e "${YELLOW}Generating new SSH key...${NC}"
    read -p "Enter email for key comment (or press enter for default): " email
    email="${email:-$(whoami)@$(hostname)}"
    
    ssh-keygen -t ed25519 -C "$email" -f "$KEY_PATH"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓ SSH key generated successfully${NC}"
    else
        echo -e "${RED}✗ Failed to generate SSH key${NC}"
        exit 1
    fi
fi

# Display public key
echo -e "\n${GREEN}Your public key:${NC}"
cat "${KEY_PATH}.pub"
echo ""

# Add to ssh-agent
echo -e "${YELLOW}Adding key to ssh-agent...${NC}"
eval "$(ssh-agent -s)" > /dev/null 2>&1

# macOS specific: add to keychain
if [[ "$OSTYPE" == "darwin"* ]]; then
    ssh-add --apple-use-keychain "$KEY_PATH" 2>/dev/null || ssh-add -K "$KEY_PATH" 2>/dev/null || ssh-add "$KEY_PATH"
else
    ssh-add "$KEY_PATH"
fi

echo -e "${GREEN}✓ Key added to ssh-agent${NC}\n"

# Distribute to hosts
echo -e "${GREEN}=== Distributing key to hosts ===${NC}\n"

for host in "${HOSTS[@]}"; do
    echo -e "${YELLOW}Copying key to $host...${NC}"
    
    # Check if host is reachable
    host_ip=$(echo "$host" | cut -d'@' -f2)
    if ! ping -c 1 -W 2 "$host_ip" > /dev/null 2>&1; then
        echo -e "${RED}✗ Host $host_ip is not reachable, skipping${NC}\n"
        continue
    fi
    
    # Copy the key
    ssh-copy-id -i "${KEY_PATH}.pub" "$host"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓ Key copied to $host${NC}\n"
    else
        echo -e "${RED}✗ Failed to copy key to $host${NC}\n"
    fi
done

echo -e "${GREEN}=== Setup Complete ===${NC}"
echo -e "\nYou can now SSH to configured hosts without a password:"
for host in "${HOSTS[@]}"; do
    echo "  ssh $host"
done

echo -e "\n${YELLOW}Tip:${NC} Add this to ~/.ssh/config for easier access:"
echo ""
echo "Host pihole1"
echo "    HostName 10.0.10.3"
echo "    User root"
echo "    IdentityFile $KEY_PATH"
echo ""
